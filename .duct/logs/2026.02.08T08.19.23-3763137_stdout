.pkg: _optional_hooks> python /home/yoh/proj/annextube/.venv/lib/python3.12/site-packages/pyproject_api/_backend.py True hatchling.build
.pkg: get_requires_for_build_sdist> python /home/yoh/proj/annextube/.venv/lib/python3.12/site-packages/pyproject_api/_backend.py True hatchling.build
.pkg: build_sdist> python /home/yoh/proj/annextube/.venv/lib/python3.12/site-packages/pyproject_api/_backend.py True hatchling.build
py310: install_package> .venv/bin/uv pip install --reinstall --no-deps annextube@/home/yoh/proj/annextube/.tox/.tmp/package/43/annextube-0.2.1.post51+g5ed38314e.d20260208.tar.gz
py310: commands[0]> pytest --ignore=tests/e2e/test_web_ui.py tests/
============================= test session starts ==============================
platform linux -- Python 3.10.17, pytest-9.0.2, pluggy-1.6.0
cachedir: .tox/py310/.pytest_cache
rootdir: /home/yoh/proj/annextube
configfile: pyproject.toml
plugins: cov-7.0.0, timeout-2.4.0, asyncio-1.3.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 170 items

tests/e2e/test_multi_channel.py F.                                       [  1%]
tests/integration/test_api_enhanced_metadata.py .......ss.               [  7%]
tests/integration/test_checkpoint_commits.py ......                      [ 10%]
tests/integration/test_comprehensive_backup.py ..                        [ 11%]
tests/integration/test_e2e_backup_features.py ..F                        [ 13%]
tests/integration/test_incremental_backup.py ..                          [ 14%]
tests/integration/test_new_video_components.py ..                        [ 15%]
tests/integration/test_no_timestamp_commits.py ...                       [ 17%]
tests/integration/test_update_annexed_files.py ..                        [ 18%]
tests/test_component_mode_bug.py ..                                      [ 20%]
tests/test_date_filtering.py .....                                       [ 22%]
tests/test_tsv_refactoring.py .....                                      [ 25%]
tests/unit/test_archive_discovery.py ........................            [ 40%]
tests/unit/test_atomic_file_write.py ..........                          [ 45%]
tests/unit/test_git_annex_metadata.py ......                             [ 49%]
tests/unit/test_git_annex_timestamp_filter.py ......                     [ 52%]
tests/unit/test_hierarchical_video_paths.py .............                [ 60%]
tests/unit/test_new_video_detection.py ..                                [ 61%]
tests/unit/test_playlist_model.py ...                                    [ 63%]
tests/unit/test_quota_estimator.py .........                             [ 68%]
tests/unit/test_quota_manager.py .....................                   [ 81%]
tests/unit/test_video_model.py ...                                       [ 82%]
tests/unit/test_youtube_api_client.py ...................                [ 94%]
tests/unit/test_youtube_api_quota_handling.py ..........                 [100%]

=================================== FAILURES ===================================
____________________ test_multi_channel_collection_workflow ____________________

    @pytest.mark.network
    @pytest.mark.ai_generated
    def test_multi_channel_collection_workflow():
        """Test complete multi-channel collection workflow.
    
        Creates a collection with two channels (AnnexTubeTesting and limited apopyk),
        aggregates metadata, and verifies web UI generation.
        """
        with tempfile.TemporaryDirectory() as tmpdir:
            collection_dir = Path(tmpdir) / "collection"
            collection_dir.mkdir()
    
            # Channel 1: AnnexTubeTesting (limit 3 videos)
            ch1_dir = collection_dir / "ch-annextubetesting"
            ch1_dir.mkdir()
    
            print("\n=== Creating channel 1: AnnexTubeTesting ===")
            result = subprocess.run(
                [
                    sys.executable,
                    "-m",
                    "annextube",
                    "init",
                    str(ch1_dir),
                    "https://www.youtube.com/@AnnexTubeTesting",
                    "--limit",
                    "3",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 1
            print("\n=== Backing up channel 1 ===")
            result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch1_dir)],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Export channel.json for channel 1
            print("\n=== Exporting channel.json for channel 1 ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "export",
                    "--output-dir",
                    str(ch1_dir),
                    "--channel-json",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Channel 2: Andriy Popyk (limit 2 videos)
            ch2_dir = collection_dir / "ch-apopyk"
            ch2_dir.mkdir()
    
            print("\n=== Creating channel 2: Andriy Popyk ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "init",
                    str(ch2_dir),
                    "https://www.youtube.com/@apopyk",
                    "--limit",
                    "2",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 2
            print("\n=== Backing up channel 2 ===")
>           result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch2_dir)],
                capture_output=True,
                text=True,
                check=True,
            )

tests/e2e/test_multi_channel.py:111: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py310/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmp2zgkyyee/collection/ch-apopyk'],)
kwargs = {'stderr': -1, 'stdout': -1, 'text': True}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py310/bin/python...>
stdout = 'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos per source (most recent)\n\n[1/1] Channel: https://www.youtube.com/@apopyk\n'
stderr = "/home/yoh/proj/annextube/.tox/py310/lib/python3.10/site-packages/google/api_core/_python_version_support.py:275: Futu...in range(256)\nError: 'latin-1' codec can't encode characters in position 74-82: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout is given, and the process takes too long, a TimeoutExpired
        exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py310/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmp2zgkyyee/collection/ch-apopyk']' returned non-zero exit status 1.

../../.local/share/uv/python/cpython-3.10.17-linux-x86_64-gnu/lib/python3.10/subprocess.py:526: CalledProcessError
----------------------------- Captured stdout call -----------------------------

=== Creating channel 1: AnnexTubeTesting ===
Initialized empty Git repository in /home/yoh/.tmp/tmp2zgkyyee/collection/ch-annextubetesting/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmp2zgkyyee/collection/ch-annextubetesting/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@AnnexTubeTesting

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 3 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 1 ===
Update mode: all-incremental
Default social window: 2026-02-01 to now
Found 1 enabled source(s)
Limit: 3 videos per source (most recent)

[1/1] Channel: https://www.youtube.com/@AnnexTubeTesting
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/video.mkv (from web...) 

19%   1 KiB             869 B/s 4s
100%  5.24 KiB         10 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/video.mkv (from web...) 

22%   1 KiB             780 B/s 4s
100%  4.62 KiB          2 MiB/s 0s
22%   1 KiB               0 B/s   
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/video.mkv (from web...) 

29%   1 KiB             904 B/s 2s
100%  3.47 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/metadata.json (non-large file; adding content to git repository) ok
ok
ok
(recording state in git...)
add playlists/Videos-with-Location-Metadata/playlist.json (non-large file; adding content to git repository) add playlists/Videos-with-Location-Metadata/0002_2026-02-05_Test-Video-Recorded-in-London add playlists/Videos-with-Location-Metadata/0001_2026-02-05_Test-Video-Recorded-in-New-York-City ok
ok
ok
(recording state in git...)
add videos/videos.tsv (non-large file; adding content to git repository) add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           570 KiB/s 0sok
ok

                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-With-English-Captions/video.mkv (from web...) 

6%    1 KiB             837 B/s 18s
100%  16.34 KiB         5 MiB/s 0s 
                                   
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/video.mkv (from web...) 

7%    1 KiB             787 B/s 16s
100%  13.79 KiB        20 MiB/s 0s 
                                   
ok
(recording state in git...)
add playlists/Videos-with-Captions/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-With-English-Captions/metadata.json (non-large file; adding content to git repository) add playlists/Videos-with-Captions/0002_2026-02-05_Test-Video-Multi-language-Captions ok
add playlists/Videos-with-Captions/0001_2026-02-05_Test-Video-With-English-Captions ok
ok
ok
ok
(recording state in git...)
add videos/videos.tsv (non-large file; adding content to git repository) add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           369 KiB/s 0s
                                  
ok
ok

                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-1/video.mkv (from web...) 

27%   1 KiB             674 B/s 4s
100%  3.72 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-2/video.mkv (from web...) 

29%   1 KiB             819 B/s 3s
100%  3.48 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-3/video.mkv (from web...) 

22%   1 KiB             751 B/s 4s
100%  4.63 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Standard-License-1/metadata.json add playlists/Mixed-License-Videos/playlist.json (non-large file; adding content to git repository) (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-2/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-3/metadata.json (non-large file; adding content to git repository) add playlists/Mixed-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 add playlists/Mixed-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 add playlists/Mixed-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 ok
ok
ok
ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           939 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/video.mkv (from web...) 

34%   1 KiB             775 B/s 2s
100%  2.94 KiB         31 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/video.mkv (from web...) 

16%   1 KiB             892 B/s 5s
100%  6.08 KiB          4 MiB/s 0s
                                  
ok
(recording state in git...)
add playlists/All-Creative-Commons-Videos/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/metadata.json (non-large file; adding content to git repository) add playlists/All-Creative-Commons-Videos/0002_2026-02-05_Test-Video-Creative-Commons-2 add playlists/All-Creative-Commons-Videos/0003_2026-02-05_Test-Video-Creative-Commons-3 add playlists/All-Creative-Commons-Videos/0001_2026-02-05_Test-Video-Creative-Commons-1 ok
ok
ok
ok
ok
ok
(recording state in git...)
add videos/videos.tsv (non-large file; adding content to git repository) add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  219 B           637 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
add playlists/All-Standard-License-Videos/playlist.json (non-large file; adding content to git repository) add playlists/All-Standard-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 ok
add playlists/All-Standard-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 add playlists/All-Standard-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 ok
ok
ok
(recording state in git...)
add authors.tsv 

100%  219 B           786 KiB/s 0s
                                  
ok
add playlists/playlists.tsv (non-large file; adding content to git repository) ok
(recording state in git...)
add authors.tsv 

100%  219 B           361 KiB/s 0s
                                  
ok
(recording state in git...)
  Summary:
    Videos processed: 10
    Videos tracked: 10
    Metadata files: 10
    Captions downloaded: 0

============================================================
Total Summary:
  Sources processed: 1
  Videos tracked: 10
  Metadata files saved: 10

[ok] Backup complete!


=== Exporting channel.json for channel 1 ===
[ok] Generated /home/yoh/.tmp/tmp2zgkyyee/collection/ch-annextubetesting/videos/videos.tsv
[ok] Generated /home/yoh/.tmp/tmp2zgkyyee/collection/ch-annextubetesting/playlists/playlists.tsv
[ok] Generated /home/yoh/.tmp/tmp2zgkyyee/collection/ch-annextubetesting/authors.tsv
[ok] Generated /home/yoh/.tmp/tmp2zgkyyee/collection/ch-annextubetesting/channel.json

[ok] Export complete!


=== Creating channel 2: Andriy Popyk ===
Initialized empty Git repository in /home/yoh/.tmp/tmp2zgkyyee/collection/ch-apopyk/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmp2zgkyyee/collection/ch-apopyk/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@apopyk

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 2 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 2 ===
_ TestE2EBackupFeatures.test_default_init_includes_playlists_with_title_paths __

self = <test_e2e_backup_features.TestE2EBackupFeatures object at 0x7f301dda1cc0>

    def test_default_init_includes_playlists_with_title_paths(self) -> None:
        """Test that default init config includes playlists and uses title-based paths."""
        with tempfile.TemporaryDirectory() as tmpdir:
            repo_path = Path(tmpdir)
    
            # Use annextube init with default settings (playlists=all, podcasts=all by default)
            # Using yarikoptic channel which has playlists
            channel_url = "https://www.youtube.com/@yarikoptic"
    
            subprocess.run(
                [sys.executable, "-m", "annextube", "init", str(repo_path), channel_url,
                 "--no-videos", "--comments", "0", "--no-captions", "--limit", "2"],
                check=True,
                capture_output=True
            )
    
            # Run backup to discover and backup playlists
>           subprocess.run(
                [sys.executable, "-m", "annextube", "backup",
                 "--output-dir", str(repo_path)],
                check=True,
                capture_output=True
            )

tests/integration/test_e2e_backup_features.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py310/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmp_bsgmcsa'],)
kwargs = {'stderr': -1, 'stdout': -1}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py310/bin/python...>
stdout = b'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos p...nok\n\r                                  \r\r                                  \rok\nok\n(recording state in git...)\n'
stderr = b"/home/yoh/proj/annextube/.tox/py310/lib/python3.10/site-packages/google/api_core/_python_version_support.py:275: Fut...in range(256)\nError: 'latin-1' codec can't encode characters in position 37-39: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout is given, and the process takes too long, a TimeoutExpired
        exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py310/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmp_bsgmcsa']' returned non-zero exit status 1.

../../.local/share/uv/python/cpython-3.10.17-linux-x86_64-gnu/lib/python3.10/subprocess.py:526: CalledProcessError
=============================== warnings summary ===============================
.tox/py310/lib/python3.10/site-packages/google/api_core/_python_version_support.py:275
  /home/yoh/proj/annextube/.tox/py310/lib/python3.10/site-packages/google/api_core/_python_version_support.py:275: FutureWarning: You are using a Python version (3.10.17) which Google will stop supporting in new releases of google.api_core once it reaches its end of life (2026-10-04). Please upgrade to the latest Python version, or at least Python 3.11, to continue receiving updates for google.api_core past that date.
    warnings.warn(message, FutureWarning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:377: YOUTUBE_API_KEY not set - skipping real API test
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:407: YOUTUBE_API_KEY not set - skipping real API test
FAILED tests/e2e/test_multi_channel.py::test_multi_channel_collection_workflow
FAILED tests/integration/test_e2e_backup_features.py::TestE2EBackupFeatures::test_default_init_includes_playlists_with_title_paths
======= 2 failed, 166 passed, 2 skipped, 1 warning in 239.57s (0:03:59) ========
py310: exit 1 (239.90 seconds) /home/yoh/proj/annextube> pytest --ignore=tests/e2e/test_web_ui.py tests/ pid=3763819
py310: FAIL âœ– in 4 minutes 17.07 seconds
py311: install_package> .venv/bin/uv pip install --reinstall --no-deps annextube@/home/yoh/proj/annextube/.tox/.tmp/package/44/annextube-0.2.1.post51+g5ed38314e.d20260208.tar.gz
py311: commands[0]> pytest --ignore=tests/e2e/test_web_ui.py tests/
============================= test session starts ==============================
platform linux -- Python 3.11.12, pytest-9.0.2, pluggy-1.6.0
cachedir: .tox/py311/.pytest_cache
rootdir: /home/yoh/proj/annextube
configfile: pyproject.toml
plugins: timeout-2.4.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 170 items

tests/e2e/test_multi_channel.py F.                                       [  1%]
tests/integration/test_api_enhanced_metadata.py .......ss.               [  7%]
tests/integration/test_checkpoint_commits.py ......                      [ 10%]
tests/integration/test_comprehensive_backup.py ..                        [ 11%]
tests/integration/test_e2e_backup_features.py ..F                        [ 13%]
tests/integration/test_incremental_backup.py ..                          [ 14%]
tests/integration/test_new_video_components.py ..                        [ 15%]
tests/integration/test_no_timestamp_commits.py ...                       [ 17%]
tests/integration/test_update_annexed_files.py ..                        [ 18%]
tests/test_component_mode_bug.py ..                                      [ 20%]
tests/test_date_filtering.py .....                                       [ 22%]
tests/test_tsv_refactoring.py .....                                      [ 25%]
tests/unit/test_archive_discovery.py ........................            [ 40%]
tests/unit/test_atomic_file_write.py ..........                          [ 45%]
tests/unit/test_git_annex_metadata.py ......                             [ 49%]
tests/unit/test_git_annex_timestamp_filter.py ......                     [ 52%]
tests/unit/test_hierarchical_video_paths.py .............                [ 60%]
tests/unit/test_new_video_detection.py ..                                [ 61%]
tests/unit/test_playlist_model.py ...                                    [ 63%]
tests/unit/test_quota_estimator.py .........                             [ 68%]
tests/unit/test_quota_manager.py .....................                   [ 81%]
tests/unit/test_video_model.py ...                                       [ 82%]
tests/unit/test_youtube_api_client.py ...................                [ 94%]
tests/unit/test_youtube_api_quota_handling.py ..........                 [100%]

=================================== FAILURES ===================================
____________________ test_multi_channel_collection_workflow ____________________

    @pytest.mark.network
    @pytest.mark.ai_generated
    def test_multi_channel_collection_workflow():
        """Test complete multi-channel collection workflow.
    
        Creates a collection with two channels (AnnexTubeTesting and limited apopyk),
        aggregates metadata, and verifies web UI generation.
        """
        with tempfile.TemporaryDirectory() as tmpdir:
            collection_dir = Path(tmpdir) / "collection"
            collection_dir.mkdir()
    
            # Channel 1: AnnexTubeTesting (limit 3 videos)
            ch1_dir = collection_dir / "ch-annextubetesting"
            ch1_dir.mkdir()
    
            print("\n=== Creating channel 1: AnnexTubeTesting ===")
            result = subprocess.run(
                [
                    sys.executable,
                    "-m",
                    "annextube",
                    "init",
                    str(ch1_dir),
                    "https://www.youtube.com/@AnnexTubeTesting",
                    "--limit",
                    "3",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 1
            print("\n=== Backing up channel 1 ===")
            result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch1_dir)],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Export channel.json for channel 1
            print("\n=== Exporting channel.json for channel 1 ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "export",
                    "--output-dir",
                    str(ch1_dir),
                    "--channel-json",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Channel 2: Andriy Popyk (limit 2 videos)
            ch2_dir = collection_dir / "ch-apopyk"
            ch2_dir.mkdir()
    
            print("\n=== Creating channel 2: Andriy Popyk ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "init",
                    str(ch2_dir),
                    "https://www.youtube.com/@apopyk",
                    "--limit",
                    "2",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 2
            print("\n=== Backing up channel 2 ===")
>           result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch2_dir)],
                capture_output=True,
                text=True,
                check=True,
            )

tests/e2e/test_multi_channel.py:111: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py311/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpdklj3tqd/collection/ch-apopyk'],)
kwargs = {'stderr': -1, 'stdout': -1, 'text': True}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py311/bin/python...>
stdout = 'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos per source (most recent)\n\n[1/1] Channel: https://www.youtube.com/@apopyk\n'
stderr = "2026-02-08 08:24:46 [INFO] annextube.cli.backup: annextube 0.2.1.post51+g5ed38314e.d20260208 with yt-dlp 2026.02.04\n...in range(256)\nError: 'latin-1' codec can't encode characters in position 74-82: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout is given, and the process takes too long, a TimeoutExpired
        exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py311/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpdklj3tqd/collection/ch-apopyk']' returned non-zero exit status 1.

../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/subprocess.py:571: CalledProcessError
----------------------------- Captured stdout call -----------------------------

=== Creating channel 1: AnnexTubeTesting ===
Initialized empty Git repository in /home/yoh/.tmp/tmpdklj3tqd/collection/ch-annextubetesting/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmpdklj3tqd/collection/ch-annextubetesting/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@AnnexTubeTesting

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 3 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 1 ===
Update mode: all-incremental
Default social window: 2026-02-01 to now
Found 1 enabled source(s)
Limit: 3 videos per source (most recent)

[1/1] Channel: https://www.youtube.com/@AnnexTubeTesting
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/video.mkv (from web...) 

19%   1 KiB             893 B/s 4s
100%  5.24 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/video.mkv (from web...) 

22%   1 KiB             870 B/s 4s
100%  4.62 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/video.mkv (from web...) 

29%   1 KiB             924 B/s 2s
100%  3.47 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/metadata.json (non-large file; adding content to git repository) ok
ok
ok
(recording state in git...)
add playlists/Videos-with-Location-Metadata/playlist.json (non-large file; adding content to git repository) add playlists/Videos-with-Location-Metadata/0002_2026-02-05_Test-Video-Recorded-in-London add playlists/Videos-with-Location-Metadata/0001_2026-02-05_Test-Video-Recorded-in-New-York-City ok
ok
ok
(recording state in git...)
add videos/videos.tsv (non-large file; adding content to git repository) add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           893 KiB/s 0sok
ok

                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-With-English-Captions/video.mkv (from web...) 

6%    1 KiB             875 B/s 17s
100%  16.34 KiB         9 MiB/s 0s 
                                   
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/video.mkv (from web...) 

7%    1 KiB             884 B/s 14s
100%  13.79 KiB         6 MiB/s 0s 
                                   
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-With-English-Captions/metadata.json (non-large file; adding content to git repository) add playlists/Videos-with-Captions/playlist.json (non-large file; adding content to git repository) add playlists/Videos-with-Captions/0002_2026-02-05_Test-Video-Multi-language-Captions add playlists/Videos-with-Captions/0001_2026-02-05_Test-Video-With-English-Captions ok
ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           775 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-1/video.mkv (from web...) 

27%   1 KiB             806 B/s 3s
100%  3.72 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-2/video.mkv (from web...) 

29%   1 KiB             887 B/s 2s
100%  3.48 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-3/video.mkv (from web...) 

22%   1 KiB             815 B/s 4s
100%  4.63 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
add playlists/Mixed-License-Videos/playlist.json add videos/2026/02/2026-02-05_Test-Video-Standard-License-1/metadata.json (non-large file; adding content to git repository) (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-2/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-3/metadata.json (non-large file; adding content to git repository) add playlists/Mixed-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 ok
add playlists/Mixed-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 add playlists/Mixed-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 ok
ok
ok
ok
ok
ok
(recording state in git...)
add videos/videos.tsv (non-large file; adding content to git repository) add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           657 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/video.mkv (from web...) 

34%   1 KiB             810 B/s 2s
100%  2.94 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/video.mkv (from web...) 

16%   1 KiB             816 B/s 6s
100%  6.08 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
add playlists/All-Creative-Commons-Videos/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/metadata.json (non-large file; adding content to git repository) add playlists/All-Creative-Commons-Videos/0001_2026-02-05_Test-Video-Creative-Commons-1 add playlists/All-Creative-Commons-Videos/0002_2026-02-05_Test-Video-Creative-Commons-2 ok
ok
add playlists/All-Creative-Commons-Videos/0003_2026-02-05_Test-Video-Creative-Commons-3 ok
ok
ok
ok
(recording state in git...)
add videos/videos.tsv (non-large file; adding content to git repository) add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  219 B           477 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
add playlists/All-Standard-License-Videos/playlist.json (non-large file; adding content to git repository) add playlists/All-Standard-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 ok
add playlists/All-Standard-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 ok
add playlists/All-Standard-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  219 B           436 KiB/s 0s
                                  
ok
ok
(recording state in git...)
add authors.tsv 

100%  219 B           561 KiB/s 0s
                                  
ok
(recording state in git...)
  Summary:
    Videos processed: 10
    Videos tracked: 10
    Metadata files: 10
    Captions downloaded: 0

============================================================
Total Summary:
  Sources processed: 1
  Videos tracked: 10
  Metadata files saved: 10

[ok] Backup complete!


=== Exporting channel.json for channel 1 ===
[ok] Generated /home/yoh/.tmp/tmpdklj3tqd/collection/ch-annextubetesting/videos/videos.tsv
[ok] Generated /home/yoh/.tmp/tmpdklj3tqd/collection/ch-annextubetesting/playlists/playlists.tsv
[ok] Generated /home/yoh/.tmp/tmpdklj3tqd/collection/ch-annextubetesting/authors.tsv
[ok] Generated /home/yoh/.tmp/tmpdklj3tqd/collection/ch-annextubetesting/channel.json

[ok] Export complete!


=== Creating channel 2: Andriy Popyk ===
Initialized empty Git repository in /home/yoh/.tmp/tmpdklj3tqd/collection/ch-apopyk/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmpdklj3tqd/collection/ch-apopyk/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@apopyk

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 2 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 2 ===
_ TestE2EBackupFeatures.test_default_init_includes_playlists_with_title_paths __

self = <test_e2e_backup_features.TestE2EBackupFeatures object at 0x7f8c479823d0>

    def test_default_init_includes_playlists_with_title_paths(self) -> None:
        """Test that default init config includes playlists and uses title-based paths."""
        with tempfile.TemporaryDirectory() as tmpdir:
            repo_path = Path(tmpdir)
    
            # Use annextube init with default settings (playlists=all, podcasts=all by default)
            # Using yarikoptic channel which has playlists
            channel_url = "https://www.youtube.com/@yarikoptic"
    
            subprocess.run(
                [sys.executable, "-m", "annextube", "init", str(repo_path), channel_url,
                 "--no-videos", "--comments", "0", "--no-captions", "--limit", "2"],
                check=True,
                capture_output=True
            )
    
            # Run backup to discover and backup playlists
>           subprocess.run(
                [sys.executable, "-m", "annextube", "backup",
                 "--output-dir", str(repo_path)],
                check=True,
                capture_output=True
            )

tests/integration/test_e2e_backup_features.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py311/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpwhmopkfj'],)
kwargs = {'stderr': -1, 'stdout': -1}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py311/bin/python...>
stdout = b'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos p...nok\n\r                                  \r\r                                  \rok\nok\n(recording state in git...)\n'
stderr = b"2026-02-08 08:26:54 [INFO] annextube.cli.backup: annextube 0.2.1.post51+g5ed38314e.d20260208 with yt-dlp 2026.02.04\...in range(256)\nError: 'latin-1' codec can't encode characters in position 37-39: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout is given, and the process takes too long, a TimeoutExpired
        exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py311/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpwhmopkfj']' returned non-zero exit status 1.

../../.local/share/uv/python/cpython-3.11.12-linux-x86_64-gnu/lib/python3.11/subprocess.py:571: CalledProcessError
=========================== short test summary info ============================
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:377: YOUTUBE_API_KEY not set - skipping real API test
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:407: YOUTUBE_API_KEY not set - skipping real API test
FAILED tests/e2e/test_multi_channel.py::test_multi_channel_collection_workflow
FAILED tests/integration/test_e2e_backup_features.py::TestE2EBackupFeatures::test_default_init_includes_playlists_with_title_paths
============= 2 failed, 166 passed, 2 skipped in 234.66s (0:03:54) =============
py311: exit 1 (234.96 seconds) /home/yoh/proj/annextube> pytest --ignore=tests/e2e/test_web_ui.py tests/ pid=3791664
py311: FAIL âœ– in 4 minutes 1.98 seconds
py312: install_package> .venv/bin/uv pip install --reinstall --no-deps annextube@/home/yoh/proj/annextube/.tox/.tmp/package/45/annextube-0.2.1.post51+g5ed38314e.d20260208.tar.gz
py312: commands[0]> pytest --ignore=tests/e2e/test_web_ui.py tests/
============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
cachedir: .tox/py312/.pytest_cache
rootdir: /home/yoh/proj/annextube
configfile: pyproject.toml
plugins: asyncio-1.3.0, timeout-2.4.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 170 items

tests/e2e/test_multi_channel.py F.                                       [  1%]
tests/integration/test_api_enhanced_metadata.py .......ss.               [  7%]
tests/integration/test_checkpoint_commits.py ......                      [ 10%]
tests/integration/test_comprehensive_backup.py ..                        [ 11%]
tests/integration/test_e2e_backup_features.py ..F                        [ 13%]
tests/integration/test_incremental_backup.py ..                          [ 14%]
tests/integration/test_new_video_components.py ..                        [ 15%]
tests/integration/test_no_timestamp_commits.py ...                       [ 17%]
tests/integration/test_update_annexed_files.py ..                        [ 18%]
tests/test_component_mode_bug.py ..                                      [ 20%]
tests/test_date_filtering.py .....                                       [ 22%]
tests/test_tsv_refactoring.py .....                                      [ 25%]
tests/unit/test_archive_discovery.py ........................            [ 40%]
tests/unit/test_atomic_file_write.py ..........                          [ 45%]
tests/unit/test_git_annex_metadata.py ......                             [ 49%]
tests/unit/test_git_annex_timestamp_filter.py ......                     [ 52%]
tests/unit/test_hierarchical_video_paths.py .............                [ 60%]
tests/unit/test_new_video_detection.py ..                                [ 61%]
tests/unit/test_playlist_model.py ...                                    [ 63%]
tests/unit/test_quota_estimator.py .........                             [ 68%]
tests/unit/test_quota_manager.py .....................                   [ 81%]
tests/unit/test_video_model.py ...                                       [ 82%]
tests/unit/test_youtube_api_client.py ...................                [ 94%]
tests/unit/test_youtube_api_quota_handling.py ..........                 [100%]

=================================== FAILURES ===================================
____________________ test_multi_channel_collection_workflow ____________________

    @pytest.mark.network
    @pytest.mark.ai_generated
    def test_multi_channel_collection_workflow():
        """Test complete multi-channel collection workflow.
    
        Creates a collection with two channels (AnnexTubeTesting and limited apopyk),
        aggregates metadata, and verifies web UI generation.
        """
        with tempfile.TemporaryDirectory() as tmpdir:
            collection_dir = Path(tmpdir) / "collection"
            collection_dir.mkdir()
    
            # Channel 1: AnnexTubeTesting (limit 3 videos)
            ch1_dir = collection_dir / "ch-annextubetesting"
            ch1_dir.mkdir()
    
            print("\n=== Creating channel 1: AnnexTubeTesting ===")
            result = subprocess.run(
                [
                    sys.executable,
                    "-m",
                    "annextube",
                    "init",
                    str(ch1_dir),
                    "https://www.youtube.com/@AnnexTubeTesting",
                    "--limit",
                    "3",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 1
            print("\n=== Backing up channel 1 ===")
            result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch1_dir)],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Export channel.json for channel 1
            print("\n=== Exporting channel.json for channel 1 ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "export",
                    "--output-dir",
                    str(ch1_dir),
                    "--channel-json",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Channel 2: Andriy Popyk (limit 2 videos)
            ch2_dir = collection_dir / "ch-apopyk"
            ch2_dir.mkdir()
    
            print("\n=== Creating channel 2: Andriy Popyk ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "init",
                    str(ch2_dir),
                    "https://www.youtube.com/@apopyk",
                    "--limit",
                    "2",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 2
            print("\n=== Backing up channel 2 ===")
>           result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch2_dir)],
                capture_output=True,
                text=True,
                check=True,
            )

tests/e2e/test_multi_channel.py:111: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py312/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpo57_d8tg/collection/ch-apopyk'],)
kwargs = {'stderr': -1, 'stdout': -1, 'text': True}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py312/bin/python...>
stdout = 'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos per source (most recent)\n\n[1/1] Channel: https://www.youtube.com/@apopyk\n'
stderr = "2026-02-08 08:28:49 [INFO] annextube.cli.backup: annextube 0.2.1.post51+g5ed38314e.d20260208 with yt-dlp 2026.02.04\n...in range(256)\nError: 'latin-1' codec can't encode characters in position 74-82: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout (seconds) is given and the process takes too long,
         a TimeoutExpired exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py312/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpo57_d8tg/collection/ch-apopyk']' returned non-zero exit status 1.

.local/share/uv/python/cpython-3.12.12-linux-x86_64-gnu/lib/python3.12/subprocess.py:571: CalledProcessError
----------------------------- Captured stdout call -----------------------------

=== Creating channel 1: AnnexTubeTesting ===
Initialized empty Git repository in /home/yoh/.tmp/tmpo57_d8tg/collection/ch-annextubetesting/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmpo57_d8tg/collection/ch-annextubetesting/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@AnnexTubeTesting

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 3 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 1 ===
Update mode: all-incremental
Default social window: 2026-02-01 to now
Found 1 enabled source(s)
Limit: 3 videos per source (most recent)

[1/1] Channel: https://www.youtube.com/@AnnexTubeTesting
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/video.mkv (from web...) 

19%   1 KiB             841 B/s 5s
100%  5.24 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/video.mkv (from web...) 

22%   1 KiB             825 B/s 4s
100%  4.62 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/video.mkv (from web...) 

29%   1 KiB             766 B/s 3s
100%  3.47 KiB          1 MiB/s 0s
                                  
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/metadata.json add videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/metadata.json (non-large file; adding content to git repository) (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/metadata.json (non-large file; adding content to git repository) ok
ok
ok
(recording state in git...)
add playlists/Videos-with-Location-Metadata/playlist.json (non-large file; adding content to git repository) add playlists/Videos-with-Location-Metadata/0002_2026-02-05_Test-Video-Recorded-in-London add playlists/Videos-with-Location-Metadata/0001_2026-02-05_Test-Video-Recorded-in-New-York-City ok
ok
ok
(recording state in git...)
add videos/videos.tsv add playlists/playlists.tsv (non-large file; adding content to git repository) (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           417 KiB/s 0sok
ok

                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-With-English-Captions/video.mkv (from web...) 

6%    1 KiB             911 B/s 17s
100%  16.34 KiB         5 MiB/s 0s 
                                   
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/video.mkv (from web...) 

7%    1 KiB             813 B/s 16s
100%  13.79 KiB         6 MiB/s 0s 
                                   
ok
(recording state in git...)
add playlists/Videos-with-Captions/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-With-English-Captions/metadata.json (non-large file; adding content to git repository) add playlists/Videos-with-Captions/0002_2026-02-05_Test-Video-Multi-language-Captions ok
add playlists/Videos-with-Captions/0001_2026-02-05_Test-Video-With-English-Captions ok
ok
ok
ok
(recording state in git...)
add videos/videos.tsv (non-large file; adding content to git repository) add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           803 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-1/video.mkv (from web...) 

27%   1 KiB             763 B/s 3s
100%  3.72 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-2/video.mkv (from web...) 

29%   1 KiB             766 B/s 3s
100%  3.48 KiB          1 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-3/video.mkv (from web...) 

22%   1 KiB             799 B/s 4s
100%  4.63 KiB          6 MiB/s 0s
                                  
ok
(recording state in git...)
add playlists/Mixed-License-Videos/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-1/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-2/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-3/metadata.json (non-large file; adding content to git repository) add playlists/Mixed-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 add playlists/Mixed-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 add playlists/Mixed-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 ok
ok
ok
ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           630 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/video.mkv (from web...) 

34%   1 KiB             825 B/s 2s
100%  2.94 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/video.mkv (from web...) 

16%   1 KiB             837 B/s 6s
100%  6.08 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
add playlists/All-Creative-Commons-Videos/playlist.json add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/metadata.json (non-large file; adding content to git repository) (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/metadata.json (non-large file; adding content to git repository) add playlists/All-Creative-Commons-Videos/0002_2026-02-05_Test-Video-Creative-Commons-2 add playlists/All-Creative-Commons-Videos/0003_2026-02-05_Test-Video-Creative-Commons-3 add playlists/All-Creative-Commons-Videos/0001_2026-02-05_Test-Video-Creative-Commons-1 ok
ok
ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  219 B           530 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
add playlists/All-Standard-License-Videos/playlist.json (non-large file; adding content to git repository) add playlists/All-Standard-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 add playlists/All-Standard-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 add playlists/All-Standard-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 ok
ok
ok
ok
(recording state in git...)
add authors.tsv 

100%  219 B           303 KiB/s 0s
                                  
ok
add playlists/playlists.tsv (non-large file; adding content to git repository) ok
(recording state in git...)
add authors.tsv 

100%  219 B          1018 KiB/s 0s
                                  
ok
(recording state in git...)
  Summary:
    Videos processed: 10
    Videos tracked: 10
    Metadata files: 10
    Captions downloaded: 0

============================================================
Total Summary:
  Sources processed: 1
  Videos tracked: 10
  Metadata files saved: 10

[ok] Backup complete!


=== Exporting channel.json for channel 1 ===
[ok] Generated /home/yoh/.tmp/tmpo57_d8tg/collection/ch-annextubetesting/videos/videos.tsv
[ok] Generated /home/yoh/.tmp/tmpo57_d8tg/collection/ch-annextubetesting/playlists/playlists.tsv
[ok] Generated /home/yoh/.tmp/tmpo57_d8tg/collection/ch-annextubetesting/authors.tsv
[ok] Generated /home/yoh/.tmp/tmpo57_d8tg/collection/ch-annextubetesting/channel.json

[ok] Export complete!


=== Creating channel 2: Andriy Popyk ===
Initialized empty Git repository in /home/yoh/.tmp/tmpo57_d8tg/collection/ch-apopyk/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmpo57_d8tg/collection/ch-apopyk/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@apopyk

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 2 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 2 ===
_ TestE2EBackupFeatures.test_default_init_includes_playlists_with_title_paths __

self = <test_e2e_backup_features.TestE2EBackupFeatures object at 0x7f19a665cc20>

    def test_default_init_includes_playlists_with_title_paths(self) -> None:
        """Test that default init config includes playlists and uses title-based paths."""
        with tempfile.TemporaryDirectory() as tmpdir:
            repo_path = Path(tmpdir)
    
            # Use annextube init with default settings (playlists=all, podcasts=all by default)
            # Using yarikoptic channel which has playlists
            channel_url = "https://www.youtube.com/@yarikoptic"
    
            subprocess.run(
                [sys.executable, "-m", "annextube", "init", str(repo_path), channel_url,
                 "--no-videos", "--comments", "0", "--no-captions", "--limit", "2"],
                check=True,
                capture_output=True
            )
    
            # Run backup to discover and backup playlists
>           subprocess.run(
                [sys.executable, "-m", "annextube", "backup",
                 "--output-dir", str(repo_path)],
                check=True,
                capture_output=True
            )

tests/integration/test_e2e_backup_features.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py312/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmp5hz7l96q'],)
kwargs = {'stderr': -1, 'stdout': -1}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py312/bin/python...>
stdout = b'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos p...nok\n\r                                  \r\r                                  \rok\nok\n(recording state in git...)\n'
stderr = b"2026-02-08 08:30:56 [INFO] annextube.cli.backup: annextube 0.2.1.post51+g5ed38314e.d20260208 with yt-dlp 2026.02.04\...in range(256)\nError: 'latin-1' codec can't encode characters in position 37-39: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout (seconds) is given and the process takes too long,
         a TimeoutExpired exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py312/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmp5hz7l96q']' returned non-zero exit status 1.

.local/share/uv/python/cpython-3.12.12-linux-x86_64-gnu/lib/python3.12/subprocess.py:571: CalledProcessError
=========================== short test summary info ============================
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:377: YOUTUBE_API_KEY not set - skipping real API test
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:407: YOUTUBE_API_KEY not set - skipping real API test
FAILED tests/e2e/test_multi_channel.py::test_multi_channel_collection_workflow
FAILED tests/integration/test_e2e_backup_features.py::TestE2EBackupFeatures::test_default_init_includes_playlists_with_title_paths
============= 2 failed, 166 passed, 2 skipped in 233.36s (0:03:53) =============
py312: exit 1 (233.72 seconds) /home/yoh/proj/annextube> pytest --ignore=tests/e2e/test_web_ui.py tests/ pid=3819313
py312: FAIL âœ– in 4 minutes 1.3 seconds
py313: install_package> .venv/bin/uv pip install --reinstall --no-deps annextube@/home/yoh/proj/annextube/.tox/.tmp/package/46/annextube-0.2.1.post51+g5ed38314e.d20260208.tar.gz
py313: commands[0]> pytest --ignore=tests/e2e/test_web_ui.py tests/
============================= test session starts ==============================
platform linux -- Python 3.13.11, pytest-9.0.2, pluggy-1.6.0
cachedir: .tox/py313/.pytest_cache
rootdir: /home/yoh/proj/annextube
configfile: pyproject.toml
plugins: cov-7.0.0, asyncio-1.3.0, timeout-2.4.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 170 items

tests/e2e/test_multi_channel.py F.                                       [  1%]
tests/integration/test_api_enhanced_metadata.py .......ss.               [  7%]
tests/integration/test_checkpoint_commits.py ......                      [ 10%]
tests/integration/test_comprehensive_backup.py ..                        [ 11%]
tests/integration/test_e2e_backup_features.py ..F                        [ 13%]
tests/integration/test_incremental_backup.py ..                          [ 14%]
tests/integration/test_new_video_components.py ..                        [ 15%]
tests/integration/test_no_timestamp_commits.py ...                       [ 17%]
tests/integration/test_update_annexed_files.py ..                        [ 18%]
tests/test_component_mode_bug.py ..                                      [ 20%]
tests/test_date_filtering.py .....                                       [ 22%]
tests/test_tsv_refactoring.py .....                                      [ 25%]
tests/unit/test_archive_discovery.py ........................            [ 40%]
tests/unit/test_atomic_file_write.py ..........                          [ 45%]
tests/unit/test_git_annex_metadata.py ......                             [ 49%]
tests/unit/test_git_annex_timestamp_filter.py ......                     [ 52%]
tests/unit/test_hierarchical_video_paths.py .............                [ 60%]
tests/unit/test_new_video_detection.py ..                                [ 61%]
tests/unit/test_playlist_model.py ...                                    [ 63%]
tests/unit/test_quota_estimator.py .........                             [ 68%]
tests/unit/test_quota_manager.py .....................                   [ 81%]
tests/unit/test_video_model.py ...                                       [ 82%]
tests/unit/test_youtube_api_client.py ...................                [ 94%]
tests/unit/test_youtube_api_quota_handling.py ..........                 [100%]

=================================== FAILURES ===================================
____________________ test_multi_channel_collection_workflow ____________________

    @pytest.mark.network
    @pytest.mark.ai_generated
    def test_multi_channel_collection_workflow():
        """Test complete multi-channel collection workflow.
    
        Creates a collection with two channels (AnnexTubeTesting and limited apopyk),
        aggregates metadata, and verifies web UI generation.
        """
        with tempfile.TemporaryDirectory() as tmpdir:
            collection_dir = Path(tmpdir) / "collection"
            collection_dir.mkdir()
    
            # Channel 1: AnnexTubeTesting (limit 3 videos)
            ch1_dir = collection_dir / "ch-annextubetesting"
            ch1_dir.mkdir()
    
            print("\n=== Creating channel 1: AnnexTubeTesting ===")
            result = subprocess.run(
                [
                    sys.executable,
                    "-m",
                    "annextube",
                    "init",
                    str(ch1_dir),
                    "https://www.youtube.com/@AnnexTubeTesting",
                    "--limit",
                    "3",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 1
            print("\n=== Backing up channel 1 ===")
            result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch1_dir)],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Export channel.json for channel 1
            print("\n=== Exporting channel.json for channel 1 ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "export",
                    "--output-dir",
                    str(ch1_dir),
                    "--channel-json",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Channel 2: Andriy Popyk (limit 2 videos)
            ch2_dir = collection_dir / "ch-apopyk"
            ch2_dir.mkdir()
    
            print("\n=== Creating channel 2: Andriy Popyk ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "init",
                    str(ch2_dir),
                    "https://www.youtube.com/@apopyk",
                    "--limit",
                    "2",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 2
            print("\n=== Backing up channel 2 ===")
>           result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch2_dir)],
                capture_output=True,
                text=True,
                check=True,
            )

tests/e2e/test_multi_channel.py:111: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py313/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpqpoyz5bl/collection/ch-apopyk'],)
kwargs = {'stderr': -1, 'stdout': -1, 'text': True}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py313/bin/python...>
stdout = 'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos per source (most recent)\n\n[1/1] Channel: https://www.youtube.com/@apopyk\n'
stderr = "2026-02-08 08:32:54 [INFO] annextube.cli.backup: annextube 0.2.1.post51+g5ed38314e.d20260208 with yt-dlp 2026.02.04\n...in range(256)\nError: 'latin-1' codec can't encode characters in position 74-82: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout (seconds) is given and the process takes too long,
         a TimeoutExpired exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py313/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpqpoyz5bl/collection/ch-apopyk']' returned non-zero exit status 1.

/usr/lib/python3.13/subprocess.py:577: CalledProcessError
----------------------------- Captured stdout call -----------------------------

=== Creating channel 1: AnnexTubeTesting ===
Initialized empty Git repository in /home/yoh/.tmp/tmpqpoyz5bl/collection/ch-annextubetesting/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmpqpoyz5bl/collection/ch-annextubetesting/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@AnnexTubeTesting

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 3 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 1 ===
Update mode: all-incremental
Default social window: 2026-02-01 to now
Found 1 enabled source(s)
Limit: 3 videos per source (most recent)

[1/1] Channel: https://www.youtube.com/@AnnexTubeTesting
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/video.mkv (from web...) 

19%   1 KiB             794 B/s 5s
100%  5.24 KiB         11 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/video.mkv (from web...) 

22%   1 KiB             784 B/s 4s
100%  4.62 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/video.mkv (from web...) 

29%   1 KiB             798 B/s 3s
100%  3.47 KiB          1 MiB/s 0s
                                  
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/metadata.json add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/metadata.json (non-large file; adding content to git repository) (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/metadata.json (non-large file; adding content to git repository) ok
ok
ok
(recording state in git...)
add playlists/Videos-with-Location-Metadata/playlist.json (non-large file; adding content to git repository) add playlists/Videos-with-Location-Metadata/0001_2026-02-05_Test-Video-Recorded-in-New-York-City ok
add playlists/Videos-with-Location-Metadata/0002_2026-02-05_Test-Video-Recorded-in-London ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           567 KiB/s 0sok
ok

                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-With-English-Captions/video.mkv (from web...) 

6%    1 KiB             824 B/s 19s
100%  16.34 KiB         7 MiB/s 0s 
                                   
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/video.mkv (from web...) 

7%    1 KiB             827 B/s 15s
100%  13.79 KiB         5 MiB/s 0s 
                                   
ok
(recording state in git...)
add playlists/Videos-with-Captions/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-With-English-Captions/metadata.json (non-large file; adding content to git repository) add playlists/Videos-with-Captions/0002_2026-02-05_Test-Video-Multi-language-Captions ok
add playlists/Videos-with-Captions/0001_2026-02-05_Test-Video-With-English-Captions ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           356 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-1/video.mkv (from web...) 

27%   1 KiB             806 B/s 3s
100%  3.72 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-2/video.mkv (from web...) 

86%   3 KiB             2 KiB/s 0s
100%  3.48 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-3/video.mkv (from web...) 

22%   1 KiB             876 B/s 4s
100%  4.63 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Standard-License-1/metadata.json (non-large file; adding content to git repository) add playlists/Mixed-License-Videos/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-2/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-3/metadata.json (non-large file; adding content to git repository) add playlists/Mixed-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 add playlists/Mixed-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 add playlists/Mixed-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 ok
ok
ok
ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           625 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/video.mkv (from web...) 

100%  2.94 KiB          2 KiB/s 0s
25%   763 B               0 B/s   
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/video.mkv (from web...) 

16%   1 KiB             892 B/s 5s
100%  6.08 KiB          4 MiB/s 0s
                                  
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/metadata.json (non-large file; adding content to git repository) add playlists/All-Creative-Commons-Videos/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/metadata.json (non-large file; adding content to git repository) add playlists/All-Creative-Commons-Videos/0003_2026-02-05_Test-Video-Creative-Commons-3 add playlists/All-Creative-Commons-Videos/0001_2026-02-05_Test-Video-Creative-Commons-1 ok
ok
add playlists/All-Creative-Commons-Videos/0002_2026-02-05_Test-Video-Creative-Commons-2 ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  219 B           289 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
add playlists/All-Standard-License-Videos/playlist.json (non-large file; adding content to git repository) add playlists/All-Standard-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 add playlists/All-Standard-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 ok
add playlists/All-Standard-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  219 B           652 KiB/s 0s
                                  
ok
ok
(recording state in git...)
add authors.tsv 

100%  219 B           635 KiB/s 0s
                                  
ok
(recording state in git...)
  Summary:
    Videos processed: 10
    Videos tracked: 10
    Metadata files: 10
    Captions downloaded: 0

============================================================
Total Summary:
  Sources processed: 1
  Videos tracked: 10
  Metadata files saved: 10

[ok] Backup complete!


=== Exporting channel.json for channel 1 ===
[ok] Generated /home/yoh/.tmp/tmpqpoyz5bl/collection/ch-annextubetesting/videos/videos.tsv
[ok] Generated /home/yoh/.tmp/tmpqpoyz5bl/collection/ch-annextubetesting/playlists/playlists.tsv
[ok] Generated /home/yoh/.tmp/tmpqpoyz5bl/collection/ch-annextubetesting/authors.tsv
[ok] Generated /home/yoh/.tmp/tmpqpoyz5bl/collection/ch-annextubetesting/channel.json

[ok] Export complete!


=== Creating channel 2: Andriy Popyk ===
Initialized empty Git repository in /home/yoh/.tmp/tmpqpoyz5bl/collection/ch-apopyk/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmpqpoyz5bl/collection/ch-apopyk/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@apopyk

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 2 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 2 ===
_ TestE2EBackupFeatures.test_default_init_includes_playlists_with_title_paths __

self = <test_e2e_backup_features.TestE2EBackupFeatures object at 0x7fa78dcf5cd0>

    def test_default_init_includes_playlists_with_title_paths(self) -> None:
        """Test that default init config includes playlists and uses title-based paths."""
        with tempfile.TemporaryDirectory() as tmpdir:
            repo_path = Path(tmpdir)
    
            # Use annextube init with default settings (playlists=all, podcasts=all by default)
            # Using yarikoptic channel which has playlists
            channel_url = "https://www.youtube.com/@yarikoptic"
    
            subprocess.run(
                [sys.executable, "-m", "annextube", "init", str(repo_path), channel_url,
                 "--no-videos", "--comments", "0", "--no-captions", "--limit", "2"],
                check=True,
                capture_output=True
            )
    
            # Run backup to discover and backup playlists
>           subprocess.run(
                [sys.executable, "-m", "annextube", "backup",
                 "--output-dir", str(repo_path)],
                check=True,
                capture_output=True
            )

tests/integration/test_e2e_backup_features.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py313/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpxg73j31r'],)
kwargs = {'stderr': -1, 'stdout': -1}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py313/bin/python...>
stdout = b'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos p...nok\n\r                                  \r\r                                  \rok\nok\n(recording state in git...)\n'
stderr = b"2026-02-08 08:35:02 [INFO] annextube.cli.backup: annextube 0.2.1.post51+g5ed38314e.d20260208 with yt-dlp 2026.02.04\...in range(256)\nError: 'latin-1' codec can't encode characters in position 37-39: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout (seconds) is given and the process takes too long,
         a TimeoutExpired exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py313/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmpxg73j31r']' returned non-zero exit status 1.

/usr/lib/python3.13/subprocess.py:577: CalledProcessError
=========================== short test summary info ============================
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:377: YOUTUBE_API_KEY not set - skipping real API test
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:407: YOUTUBE_API_KEY not set - skipping real API test
FAILED tests/e2e/test_multi_channel.py::test_multi_channel_collection_workflow
FAILED tests/integration/test_e2e_backup_features.py::TestE2EBackupFeatures::test_default_init_includes_playlists_with_title_paths
============= 2 failed, 166 passed, 2 skipped in 238.28s (0:03:58) =============
py313: exit 1 (238.89 seconds) /home/yoh/proj/annextube> pytest --ignore=tests/e2e/test_web_ui.py tests/ pid=3846737
py313: FAIL âœ– in 4 minutes 6.89 seconds
py314: install_package> .venv/bin/uv pip install --reinstall --no-deps annextube@/home/yoh/proj/annextube/.tox/.tmp/package/47/annextube-0.2.1.post51+g5ed38314e.d20260208.tar.gz
py314: commands[0]> pytest --ignore=tests/e2e/test_web_ui.py tests/
============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0
cachedir: .tox/py314/.pytest_cache
rootdir: /home/yoh/proj/annextube
configfile: pyproject.toml
plugins: timeout-2.4.0, cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 170 items

tests/e2e/test_multi_channel.py F.                                       [  1%]
tests/integration/test_api_enhanced_metadata.py .......ss.               [  7%]
tests/integration/test_checkpoint_commits.py ......                      [ 10%]
tests/integration/test_comprehensive_backup.py ..                        [ 11%]
tests/integration/test_e2e_backup_features.py ..F                        [ 13%]
tests/integration/test_incremental_backup.py ..                          [ 14%]
tests/integration/test_new_video_components.py ..                        [ 15%]
tests/integration/test_no_timestamp_commits.py ...                       [ 17%]
tests/integration/test_update_annexed_files.py ..                        [ 18%]
tests/test_component_mode_bug.py ..                                      [ 20%]
tests/test_date_filtering.py .....                                       [ 22%]
tests/test_tsv_refactoring.py .....                                      [ 25%]
tests/unit/test_archive_discovery.py ........................            [ 40%]
tests/unit/test_atomic_file_write.py ..........                          [ 45%]
tests/unit/test_git_annex_metadata.py ......                             [ 49%]
tests/unit/test_git_annex_timestamp_filter.py ......                     [ 52%]
tests/unit/test_hierarchical_video_paths.py .............                [ 60%]
tests/unit/test_new_video_detection.py ..                                [ 61%]
tests/unit/test_playlist_model.py ...                                    [ 63%]
tests/unit/test_quota_estimator.py .........                             [ 68%]
tests/unit/test_quota_manager.py .....................                   [ 81%]
tests/unit/test_video_model.py ...                                       [ 82%]
tests/unit/test_youtube_api_client.py ...................                [ 94%]
tests/unit/test_youtube_api_quota_handling.py ..........                 [100%]

=================================== FAILURES ===================================
____________________ test_multi_channel_collection_workflow ____________________

    @pytest.mark.network
    @pytest.mark.ai_generated
    def test_multi_channel_collection_workflow():
        """Test complete multi-channel collection workflow.
    
        Creates a collection with two channels (AnnexTubeTesting and limited apopyk),
        aggregates metadata, and verifies web UI generation.
        """
        with tempfile.TemporaryDirectory() as tmpdir:
            collection_dir = Path(tmpdir) / "collection"
            collection_dir.mkdir()
    
            # Channel 1: AnnexTubeTesting (limit 3 videos)
            ch1_dir = collection_dir / "ch-annextubetesting"
            ch1_dir.mkdir()
    
            print("\n=== Creating channel 1: AnnexTubeTesting ===")
            result = subprocess.run(
                [
                    sys.executable,
                    "-m",
                    "annextube",
                    "init",
                    str(ch1_dir),
                    "https://www.youtube.com/@AnnexTubeTesting",
                    "--limit",
                    "3",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 1
            print("\n=== Backing up channel 1 ===")
            result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch1_dir)],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Export channel.json for channel 1
            print("\n=== Exporting channel.json for channel 1 ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "export",
                    "--output-dir",
                    str(ch1_dir),
                    "--channel-json",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Channel 2: Andriy Popyk (limit 2 videos)
            ch2_dir = collection_dir / "ch-apopyk"
            ch2_dir.mkdir()
    
            print("\n=== Creating channel 2: Andriy Popyk ===")
            result = subprocess.run(
                [
                    sys.executable, "-m", "annextube",
                    "init",
                    str(ch2_dir),
                    "https://www.youtube.com/@apopyk",
                    "--limit",
                    "2",
                    "--comments",
                    "0",
                    "--no-captions",
                    "--no-thumbnails",
                ],
                capture_output=True,
                text=True,
                check=True,
            )
            print(result.stdout)
    
            # Backup channel 2
            print("\n=== Backing up channel 2 ===")
>           result = subprocess.run(
                [sys.executable, "-m", "annextube", "backup", "--output-dir", str(ch2_dir)],
                capture_output=True,
                text=True,
                check=True,
            )

tests/e2e/test_multi_channel.py:111: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py314/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmp9tql46dj/collection/ch-apopyk'],)
kwargs = {'stderr': -1, 'stdout': -1, 'text': True}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py314/bin/python...>
stdout = 'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos per source (most recent)\n\n[1/1] Channel: https://www.youtube.com/@apopyk\n'
stderr = "2026-02-08 08:36:59 [INFO] annextube.cli.backup: annextube 0.2.1.post51+g5ed38314e.d20260208 with yt-dlp 2026.02.04\n...in range(256)\nError: 'latin-1' codec can't encode characters in position 74-82: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout (seconds) is given and the process takes too long,
         a TimeoutExpired exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py314/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmp9tql46dj/collection/ch-apopyk']' returned non-zero exit status 1.

/usr/lib/python3.14/subprocess.py:577: CalledProcessError
----------------------------- Captured stdout call -----------------------------

=== Creating channel 1: AnnexTubeTesting ===
Initialized empty Git repository in /home/yoh/.tmp/tmp9tql46dj/collection/ch-annextubetesting/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmp9tql46dj/collection/ch-annextubetesting/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@AnnexTubeTesting

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 3 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 1 ===
Update mode: all-incremental
Default social window: 2026-02-01 to now
Found 1 enabled source(s)
Limit: 3 videos per source (most recent)

[1/1] Channel: https://www.youtube.com/@AnnexTubeTesting
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/video.mkv (from web...) 

19%   1 KiB             957 B/s 4s
100%  5.24 KiB          4 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/video.mkv (from web...) 

22%   1 KiB             891 B/s 4s
100%  4.62 KiB          4 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/video.mkv (from web...) 

29%   1 KiB             895 B/s 2s
100%  3.47 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
add videos/2026/02/2026-02-05_Test-Video-Recorded-in-New-York-City/metadata.json add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-2/metadata.json add videos/2026/02/2026-02-05_Test-Video-Recorded-in-London/metadata.json (non-large file; adding content to git repository) (non-large file; adding content to git repository) (non-large file; adding content to git repository) ok
ok
ok
(recording state in git...)
add playlists/Videos-with-Location-Metadata/playlist.json (non-large file; adding content to git repository) add playlists/Videos-with-Location-Metadata/0001_2026-02-05_Test-Video-Recorded-in-New-York-City add playlists/Videos-with-Location-Metadata/0002_2026-02-05_Test-Video-Recorded-in-London ok
ok
ok
(recording state in git...)
add videos/videos.tsv (non-large file; adding content to git repository) add playlists/playlists.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           786 KiB/s 0sok
ok

                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-With-English-Captions/video.mkv (from web...) 

6%    1 KiB             835 B/s 18s
100%  16.34 KiB         6 MiB/s 0s 
                                   
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/video.mkv (from web...) 

7%    1 KiB             876 B/s 14s
100%  13.79 KiB         6 MiB/s 0s 
                                   
ok
(recording state in git...)
add playlists/Videos-with-Captions/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Multi-language-Captions/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-With-English-Captions/metadata.json (non-large file; adding content to git repository) add playlists/Videos-with-Captions/0002_2026-02-05_Test-Video-Multi-language-Captions add playlists/Videos-with-Captions/0001_2026-02-05_Test-Video-With-English-Captions ok
ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           612 KiB/s 0s
                                  

                                  
ok
ok
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-1/video.mkv (from web...) 

27%   1 KiB             634 B/s 4s
100%  3.72 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-2/video.mkv (from web...) 

29%   1 KiB             804 B/s 3s
100%  3.48 KiB          1 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Standard-License-3/video.mkv (from web...) 

22%   1 KiB             918 B/s 4s
100%  4.63 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
add playlists/Mixed-License-Videos/playlist.json add videos/2026/02/2026-02-05_Test-Video-Standard-License-1/metadata.json (non-large file; adding content to git repository) (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-2/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Standard-License-3/metadata.json (non-large file; adding content to git repository) add playlists/Mixed-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 add playlists/Mixed-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 ok
ok
add playlists/Mixed-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 ok
ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  218 B           472 KiB/s 0s
                                  
ok
ok

                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/video.mkv (from web...) 

34%   1 KiB             846 B/s 2s
100%  2.94 KiB          3 MiB/s 0s
                                  
ok
(recording state in git...)
get videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/video.mkv (from web...) 

16%   1 KiB             876 B/s 5s
100%  6.08 KiB          2 MiB/s 0s
                                  
ok
(recording state in git...)
add playlists/All-Creative-Commons-Videos/playlist.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-1/metadata.json (non-large file; adding content to git repository) add videos/2026/02/2026-02-05_Test-Video-Creative-Commons-3/metadata.json (non-large file; adding content to git repository) add playlists/All-Creative-Commons-Videos/0002_2026-02-05_Test-Video-Creative-Commons-2 add playlists/All-Creative-Commons-Videos/0003_2026-02-05_Test-Video-Creative-Commons-3 add playlists/All-Creative-Commons-Videos/0001_2026-02-05_Test-Video-Creative-Commons-1 ok
ok
ok
ok
ok
ok
(recording state in git...)
add playlists/playlists.tsv (non-large file; adding content to git repository) add videos/videos.tsv (non-large file; adding content to git repository) add authors.tsv 

100%  219 B           657 KiB/s 0s
                                  
ok
ok

                                  
ok
(recording state in git...)
add playlists/All-Standard-License-Videos/playlist.json (non-large file; adding content to git repository) add playlists/All-Standard-License-Videos/0002_2026-02-05_Test-Video-Standard-License-2 add playlists/All-Standard-License-Videos/0001_2026-02-05_Test-Video-Standard-License-1 ok
add playlists/All-Standard-License-Videos/0003_2026-02-05_Test-Video-Standard-License-3 ok
ok
ok
(recording state in git...)
add authors.tsv 

100%  219 B           275 KiB/s 0s
                                  
ok
add playlists/playlists.tsv (non-large file; adding content to git repository) ok
(recording state in git...)
add authors.tsv 

100%  219 B           369 KiB/s 0s
                                  
ok
(recording state in git...)
  Summary:
    Videos processed: 10
    Videos tracked: 10
    Metadata files: 10
    Captions downloaded: 0

============================================================
Total Summary:
  Sources processed: 1
  Videos tracked: 10
  Metadata files saved: 10

[ok] Backup complete!


=== Exporting channel.json for channel 1 ===
[ok] Generated /home/yoh/.tmp/tmp9tql46dj/collection/ch-annextubetesting/videos/videos.tsv
[ok] Generated /home/yoh/.tmp/tmp9tql46dj/collection/ch-annextubetesting/playlists/playlists.tsv
[ok] Generated /home/yoh/.tmp/tmp9tql46dj/collection/ch-annextubetesting/authors.tsv
[ok] Generated /home/yoh/.tmp/tmp9tql46dj/collection/ch-annextubetesting/channel.json

[ok] Export complete!


=== Creating channel 2: Andriy Popyk ===
Initialized empty Git repository in /home/yoh/.tmp/tmp9tql46dj/collection/ch-apopyk/.git/
init annextube YouTube archive ok
(recording state in git...)
add .gitattributes (dotfile; adding content to git repository) add .annextube/config.toml (dotfile; adding content to git repository) ok
ok
(recording state in git...)
Initialized YouTube archive repository in current directory
Git-annex backend: URL (for video URLs)
Tracking configuration:
  - *.json, *.tsv, *.md, *.vtt -> git
  - *.mp4, *.webm, *.jpg, *.png -> git-annex

Configuration created: /home/yoh/.tmp/tmp9tql46dj/collection/ch-apopyk/.annextube/config.toml
Added 1 source(s):
  - https://www.youtube.com/@apopyk

Component settings:
  - Videos: enabled
  - Comments: disabled
  - Captions: disabled
  - Thumbnails: disabled
  - Limit: 2 most recent videos
  - Playlists: all
  - Podcasts: all

Next steps:
  Run: annextube backup


=== Backing up channel 2 ===
_ TestE2EBackupFeatures.test_default_init_includes_playlists_with_title_paths __

self = <test_e2e_backup_features.TestE2EBackupFeatures object at 0x7fe0f13b49d0>

    def test_default_init_includes_playlists_with_title_paths(self) -> None:
        """Test that default init config includes playlists and uses title-based paths."""
        with tempfile.TemporaryDirectory() as tmpdir:
            repo_path = Path(tmpdir)
    
            # Use annextube init with default settings (playlists=all, podcasts=all by default)
            # Using yarikoptic channel which has playlists
            channel_url = "https://www.youtube.com/@yarikoptic"
    
            subprocess.run(
                [sys.executable, "-m", "annextube", "init", str(repo_path), channel_url,
                 "--no-videos", "--comments", "0", "--no-captions", "--limit", "2"],
                check=True,
                capture_output=True
            )
    
            # Run backup to discover and backup playlists
>           subprocess.run(
                [sys.executable, "-m", "annextube", "backup",
                 "--output-dir", str(repo_path)],
                check=True,
                capture_output=True
            )

tests/integration/test_e2e_backup_features.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

input = None, capture_output = True, timeout = None, check = True
popenargs = (['/home/yoh/proj/annextube/.tox/py314/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmppj3bz79m'],)
kwargs = {'stderr': -1, 'stdout': -1}
process = <Popen: returncode: 1 args: ['/home/yoh/proj/annextube/.tox/py314/bin/python...>
stdout = b'Update mode: all-incremental\nDefault social window: 2026-02-01 to now\nFound 1 enabled source(s)\nLimit: 2 videos p...nok\n\r                                  \r\r                                  \rok\nok\n(recording state in git...)\n'
stderr = b"2026-02-08 08:39:07 [INFO] annextube.cli.backup: annextube 0.2.1.post51+g5ed38314e.d20260208 with yt-dlp 2026.02.04\...in range(256)\nError: 'latin-1' codec can't encode characters in position 37-39: ordinal not in range(256)\nAborted!\n"
retcode = 1

    def run(*popenargs,
            input=None, capture_output=False, timeout=None, check=False, **kwargs):
        """Run command with arguments and return a CompletedProcess instance.
    
        The returned instance will have attributes args, returncode, stdout and
        stderr. By default, stdout and stderr are not captured, and those attributes
        will be None. Pass stdout=PIPE and/or stderr=PIPE in order to capture them,
        or pass capture_output=True to capture both.
    
        If check is True and the exit code was non-zero, it raises a
        CalledProcessError. The CalledProcessError object will have the return code
        in the returncode attribute, and output & stderr attributes if those streams
        were captured.
    
        If timeout (seconds) is given and the process takes too long,
         a TimeoutExpired exception will be raised.
    
        There is an optional argument "input", allowing you to
        pass bytes or a string to the subprocess's stdin.  If you use this argument
        you may not also use the Popen constructor's "stdin" argument, as
        it will be used internally.
    
        By default, all communication is in bytes, and therefore any "input" should
        be bytes, and the stdout and stderr will be bytes. If in text mode, any
        "input" should be a string, and stdout and stderr will be strings decoded
        according to locale encoding, or by "encoding" if set. Text mode is
        triggered by setting any of text, encoding, errors or universal_newlines.
    
        The other arguments are the same as for the Popen constructor.
        """
        if input is not None:
            if kwargs.get('stdin') is not None:
                raise ValueError('stdin and input arguments may not both be used.')
            kwargs['stdin'] = PIPE
    
        if capture_output:
            if kwargs.get('stdout') is not None or kwargs.get('stderr') is not None:
                raise ValueError('stdout and stderr arguments may not be used '
                                 'with capture_output.')
            kwargs['stdout'] = PIPE
            kwargs['stderr'] = PIPE
    
        with Popen(*popenargs, **kwargs) as process:
            try:
                stdout, stderr = process.communicate(input, timeout=timeout)
            except TimeoutExpired as exc:
                process.kill()
                if _mswindows:
                    # Windows accumulates the output in a single blocking
                    # read() call run on child threads, with the timeout
                    # being done in a join() on those threads.  communicate()
                    # _after_ kill() is required to collect that and add it
                    # to the exception.
                    exc.stdout, exc.stderr = process.communicate()
                else:
                    # POSIX _communicate already populated the output so
                    # far into the TimeoutExpired exception.
                    process.wait()
                raise
            except:  # Including KeyboardInterrupt, communicate handled that.
                process.kill()
                # We don't call process.wait() as .__exit__ does that for us.
                raise
            retcode = process.poll()
            if check and retcode:
>               raise CalledProcessError(retcode, process.args,
                                         output=stdout, stderr=stderr)
E               subprocess.CalledProcessError: Command '['/home/yoh/proj/annextube/.tox/py314/bin/python3', '-m', 'annextube', 'backup', '--output-dir', '/home/yoh/.tmp/tmppj3bz79m']' returned non-zero exit status 1.

/usr/lib/python3.14/subprocess.py:577: CalledProcessError
=========================== short test summary info ============================
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:377: YOUTUBE_API_KEY not set - skipping real API test
SKIPPED [1] tests/integration/test_api_enhanced_metadata.py:407: YOUTUBE_API_KEY not set - skipping real API test
FAILED tests/e2e/test_multi_channel.py::test_multi_channel_collection_workflow
FAILED tests/integration/test_e2e_backup_features.py::TestE2EBackupFeatures::test_default_init_includes_playlists_with_title_paths
============= 2 failed, 166 passed, 2 skipped in 236.14s (0:03:56) =============
py314: exit 1 (236.78 seconds) /home/yoh/proj/annextube> pytest --ignore=tests/e2e/test_web_ui.py tests/ pid=3874522
py314: FAIL âœ– in 4 minutes 4.2 seconds
lint: commands[0]> ruff check annextube/ tests/
UP035 `typing.Tuple` is deprecated, use `tuple` instead
  --> annextube/_version.py:15:5
   |
13 | TYPE_CHECKING = False
14 | if TYPE_CHECKING:
15 |     from typing import Tuple
   |     ^^^^^^^^^^^^^^^^^^^^^^^^
16 |     from typing import Union
   |

I001 [*] Import block is un-sorted or un-formatted
  --> annextube/_version.py:15:5
   |
13 |   TYPE_CHECKING = False
14 |   if TYPE_CHECKING:
15 | /     from typing import Tuple
16 | |     from typing import Union
   | |____________________________^
17 |
18 |       VERSION_TUPLE = Tuple[Union[int, str], ...]
   |
help: Organize imports

UP006 [*] Use `tuple` instead of `Tuple` for type annotation
  --> annextube/_version.py:18:21
   |
16 |     from typing import Union
17 |
18 |     VERSION_TUPLE = Tuple[Union[int, str], ...]
   |                     ^^^^^
19 |     COMMIT_ID = Union[str, None]
20 | else:
   |
help: Replace with `tuple`

UP007 [*] Use `X | Y` for type annotations
  --> annextube/_version.py:18:27
   |
16 |     from typing import Union
17 |
18 |     VERSION_TUPLE = Tuple[Union[int, str], ...]
   |                           ^^^^^^^^^^^^^^^
19 |     COMMIT_ID = Union[str, None]
20 | else:
   |
help: Convert to `X | Y`

UP007 Use `X | Y` for type annotations
  --> annextube/_version.py:19:17
   |
18 |     VERSION_TUPLE = Tuple[Union[int, str], ...]
19 |     COMMIT_ID = Union[str, None]
   |                 ^^^^^^^^^^^^^^^^
20 | else:
21 |     VERSION_TUPLE = object
   |
help: Convert to `X | Y`

F401 [*] `annextube.models.channel.Channel` imported but unused
  --> annextube/cli/aggregate.py:10:38
   |
 9 | from annextube.lib.logging_config import get_logger
10 | from annextube.models.channel import Channel
   |                                      ^^^^^^^
11 |
12 | logger = get_logger(__name__)
   |
help: Remove unused import: `annextube.models.channel.Channel`

UP015 [*] Unnecessary mode argument
  --> annextube/cli/aggregate.py:70:31
   |
69 |     try:
70 |         with open(videos_tsv, 'r', encoding='utf-8') as f:
   |                               ^^^
71 |             reader = csv.DictReader(f, delimiter='\t')
72 |             rows = list(reader)
   |
help: Remove mode argument

UP015 [*] Unnecessary mode argument
   --> annextube/cli/aggregate.py:177:42
    |
175 |         try:
176 |             # Load channel.json
177 |             with open(channel_json_path, 'r', encoding='utf-8') as f:
    |                                          ^^^
178 |                 channel_data = json.load(f)
    |
help: Remove mode argument

UP015 [*] Unnecessary mode argument
  --> annextube/cli/export.py:67:42
   |
65 |         for metadata_file in videos_dir.rglob("metadata.json"):
66 |             try:
67 |                 with open(metadata_file, 'r', encoding='utf-8') as f:
   |                                          ^^^
68 |                     video_data = json.load(f)
69 |                     channel_id = channel_id or video_data.get("channel_id", "")
   |
help: Remove mode argument

UP015 [*] Unnecessary mode argument
  --> annextube/cli/export.py:87:35
   |
85 |     if videos_tsv.exists():
86 |         try:
87 |             with open(videos_tsv, 'r', encoding='utf-8') as f:
   |                                   ^^^
88 |                 reader = csv.DictReader(f, delimiter='\t')
89 |                 rows = list(reader)
   |
help: Remove mode argument

F841 Local variable `playlist_count` is assigned to but never used
   --> annextube/cli/export.py:116:9
    |
114 |     playlist_count = 0
115 |     if playlists_dir.exists():
116 |         playlist_count = len(list(playlists_dir.glob("*/playlist.json")))
    |         ^^^^^^^^^^^^^^
117 |
118 |     # Build channel.json
    |
help: Remove assignment to unused variable `playlist_count`

I001 [*] Import block is un-sorted or un-formatted
  --> annextube/lib/archive_discovery.py:7:1
   |
 5 |   """
 6 |
 7 | / from dataclasses import dataclass
 8 | | from pathlib import Path
 9 | | from typing import Literal
10 | |
11 | | from annextube.services.git_annex import GitAnnexService
   | |________________________________________________________^
   |
help: Organize imports

F401 [*] `annextube.lib.quota_manager.QuotaExceededError` imported but unused
  --> annextube/services/youtube_api.py:24:41
   |
23 | from annextube.lib.logging_config import get_logger
24 | from annextube.lib.quota_manager import QuotaExceededError, QuotaManager
   |                                         ^^^^^^^^^^^^^^^^^^
25 |
26 | logger = get_logger(__name__)
   |
help: Remove unused import: `annextube.lib.quota_manager.QuotaExceededError`

F541 [*] f-string without any placeholders
   --> tests/e2e/test_multi_channel.py:232:15
    |
230 |         print(f"Collection directory: {collection_dir}")
231 |         print("Structure:")
232 |         print(f"  - channels.tsv (2 channels)")
    |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
233 |         print(f"  - ch-annextubetesting/ ({ch1_data['archive_stats']['total_videos_archived']} videos)")
234 |         print(f"  - ch-apopyk/ ({ch2_data['archive_stats']['total_videos_archived']} videos)")
    |
help: Remove extraneous `f` prefix

F541 [*] f-string without any placeholders
   --> tests/e2e/test_multi_channel.py:235:15
    |
233 |         print(f"  - ch-annextubetesting/ ({ch1_data['archive_stats']['total_videos_archived']} videos)")
234 |         print(f"  - ch-apopyk/ ({ch2_data['archive_stats']['total_videos_archived']} videos)")
235 |         print(f"  - web/index.html")
    |               ^^^^^^^^^^^^^^^^^^^^^
    |
help: Remove extraneous `f` prefix

F401 [*] `json` imported but unused
 --> tests/integration/test_checkpoint_commits.py:3:8
  |
1 | """Integration tests for periodic checkpoint commits during backup."""
2 |
3 | import json
  |        ^^^^
4 | import subprocess
5 | import tempfile
  |
help: Remove unused import: `json`

F811 [*] Redefinition of unused `json` from line 3
  --> tests/integration/test_checkpoint_commits.py:63:16
   |
61 |     def mock_process_video(video):
62 |         """Mock that creates actual metadata.json files for git to track."""
63 |         import json
   |                ^^^^ `json` redefined here
64 |
65 |         # Get video directory path using archiver's method
   |
  ::: tests/integration/test_checkpoint_commits.py:3:8
   |
 1 | """Integration tests for periodic checkpoint commits during backup."""
 2 |
 3 | import json
   |        ---- previous definition of `json` here
 4 | import subprocess
 5 | import tempfile
   |
help: Remove definition: `json`

F841 Local variable `result` is assigned to but never used
   --> tests/integration/test_checkpoint_commits.py:283:29
    |
281 |                         # Create files for first 2 videos
282 |                         if process_count[0] < 3:
283 |                             result = base_mock(video)
    |                             ^^^^^^
284 |                         if process_count[0] == 3:
285 |                             raise KeyboardInterrupt("User interrupted")
    |
help: Remove assignment to unused variable `result`

F841 Local variable `result` is assigned to but never used
   --> tests/integration/test_checkpoint_commits.py:342:29
    |
340 |                         # Create files for first 2 videos
341 |                         if process_count[0] < 3:
342 |                             result = base_mock(video)
    |                             ^^^^^^
343 |                         if process_count[0] == 3:
344 |                             raise KeyboardInterrupt("User interrupted")
    |
help: Remove assignment to unused variable `result`

F401 [*] `zoneinfo.ZoneInfo` imported but unused
 --> tests/unit/test_quota_manager.py:5:22
  |
3 | from datetime import datetime, timedelta, timezone
4 | from unittest.mock import MagicMock, patch
5 | from zoneinfo import ZoneInfo
  |                      ^^^^^^^^
6 |
7 | import pytest
  |
help: Remove unused import: `zoneinfo.ZoneInfo`

Found 20 errors.
[*] 15 fixable with the `--fix` option (3 hidden fixes can be enabled with the `--unsafe-fixes` option).
lint: exit 1 (0.08 seconds) /home/yoh/proj/annextube> ruff check annextube/ tests/ pid=3901868
lint: FAIL âœ– in 0.09 seconds
type: commands[0]> mypy --ignore-missing-imports annextube/
annextube/models/channel.py:36: error: Incompatible types in assignment (expression has type "dict[Never, Never]", variable has type "ArchiveStats")  [assignment]
annextube/cli/aggregate.py:80: error: Value of type variable "SupportsRichComparisonT" of "min" cannot be "str | Any | None"  [type-var]
annextube/cli/aggregate.py:80: error: Incompatible types in assignment (expression has type "str | Any | None", target has type "int | None")  [assignment]
annextube/cli/aggregate.py:81: error: Value of type variable "SupportsRichComparisonT" of "max" cannot be "str | Any | None"  [type-var]
annextube/cli/aggregate.py:81: error: Incompatible types in assignment (expression has type "str | Any | None", target has type "int | None")  [assignment]
annextube/cli/aggregate.py:87: error: Unsupported operand types for + ("None" and "int")  [operator]
annextube/cli/aggregate.py:87: note: Left operand is of type "int | None"
annextube/cli/aggregate.py:95: error: Unsupported operand types for + ("None" and "int")  [operator]
annextube/cli/aggregate.py:95: note: Left operand is of type "int | None"
annextube/services/youtube_api.py:83: error: Need type annotation for "all_comments" (hint: "all_comments: list[<type>] = ...")  [var-annotated]
annextube/cli/export.py:96: error: Value of type variable "SupportsRichComparisonT" of "min" cannot be "str | Any | None"  [type-var]
annextube/cli/export.py:96: error: Incompatible types in assignment (expression has type "str | Any | None", target has type "int | None")  [assignment]
annextube/cli/export.py:97: error: Value of type variable "SupportsRichComparisonT" of "max" cannot be "str | Any | None"  [type-var]
annextube/cli/export.py:97: error: Incompatible types in assignment (expression has type "str | Any | None", target has type "int | None")  [assignment]
annextube/cli/export.py:101: error: Unsupported operand types for + ("None" and "int")  [operator]
annextube/cli/export.py:101: note: Left operand is of type "int | None"
annextube/cli/export.py:106: error: Unsupported operand types for + ("None" and "int")  [operator]
annextube/cli/export.py:106: note: Left operand is of type "int | None"
annextube/services/youtube.py:307: error: Need type annotation for "new_video_ids" (hint: "new_video_ids: list[<type>] = ...")  [var-annotated]
annextube/services/archiver.py:1263: error: If x = b'abc' then f"{x}" or "{}".format(x) produces "b'abc'", not "abc". If this is desired behavior, use f"{x!r}" or "{!r}".format(x). Otherwise, decode the bytes  [str-bytes-safe]
Found 16 errors in 6 files (checked 35 source files)
type: exit 1 (0.57 seconds) /home/yoh/proj/annextube> mypy --ignore-missing-imports annextube/ pid=3901913
type: FAIL âœ– in 0.57 seconds
e2e: install_package> .venv/bin/uv pip install --reinstall --no-deps annextube@/home/yoh/proj/annextube/.tox/.tmp/package/48/annextube-0.2.1.post51+g5ed38314e.d20260208.tar.gz
e2e: commands[0] /home/yoh/proj/annextube/frontend> npm install

up to date, audited 671 packages in 923ms

137 packages are looking for funding
  run `npm fund` for details

8 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
e2e: commands[1] /home/yoh/proj/annextube/frontend> npm run build

> annextube-frontend@0.1.0 build
> vite build

vite v5.4.21 building for production...
transforming...
âœ“ 53 modules transformed.
rendering chunks...
computing gzip size...
../web/index.html                  0.49 kB â”‚ gzip:  0.31 kB
../web/assets/index-zXhaaQLs.css  18.13 kB â”‚ gzip:  3.51 kB
../web/assets/index-Fj-wER0D.js   85.42 kB â”‚ gzip: 27.44 kB
âœ“ built in 1.14s
e2e: commands[2] /home/yoh/proj/annextube/frontend> bash scripts/ensure-playwright-browsers.sh chromium
Checking if Playwright chromium is already installed...
FOUND: /home/yoh/.cache/ms-playwright/chromium-1208/chrome-linux64/chrome
Playwright chromium is already installed, skipping download.
e2e: commands[3] /home/yoh/proj/annextube/frontend> npm run test:e2e -- archive-workflow.spec.ts --project=archive-chromium

> annextube-frontend@0.1.0 test:e2e
> playwright test archive-workflow.spec.ts --project=archive-chromium



Error: Process from config.webServer was not able to start. Exit code: 1

[1A[2K
To open last HTML report run:

  npx playwright show-report

e2e: exit 1 (4.39 seconds) /home/yoh/proj/annextube/frontend> npm run test:e2e -- archive-workflow.spec.ts --project=archive-chromium pid=3902477
.pkg: _exit> python /home/yoh/proj/annextube/.venv/lib/python3.12/site-packages/pyproject_api/_backend.py True hatchling.build
  py310: FAIL code 1 (257.07=setup[17.17]+cmd[239.90] seconds)
  py311: FAIL code 1 (241.98=setup[7.02]+cmd[234.96] seconds)
  py312: FAIL code 1 (241.30=setup[7.58]+cmd[233.72] seconds)
  py313: FAIL code 1 (246.89=setup[7.99]+cmd[238.89] seconds)
  py314: FAIL code 1 (244.20=setup[7.42]+cmd[236.78] seconds)
  lint: FAIL code 1 (0.09=setup[0.00]+cmd[0.08] seconds)
  type: FAIL code 1 (0.57=setup[0.01]+cmd[0.57] seconds)
  e2e: FAIL code 1 (15.77=setup[7.72]+cmd[1.22,1.91,0.53,4.39] seconds)
  evaluation failed :( (1247.91 seconds)
