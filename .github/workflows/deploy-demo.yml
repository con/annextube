name: Deploy Demo to GitHub Pages

on:
  push:
    branches: [ master ]
    paths:
      - 'annextube/**'
      - 'frontend/**'
      - '.github/workflows/deploy-demo.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for gh-pages branch

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install git-annex
        run: |
          sudo apt-get update
          sudo apt-get install -y git-annex

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Generate demo archive
        run: |
          # Verify deno is available
          which deno
          deno --version

          # Create temp demo directory
          mkdir -p demo-build
          cd demo-build

          # Initialize archive with test channel (all files in git for GitHub Pages)
          uv run annextube init . https://www.youtube.com/@AnnexTubeTesting \
            --comments 0 --limit 10 --all-to-git

          # Run backup to fetch data
          uv run annextube backup --output-dir .

          # Generate web UI
          uv run annextube generate-web --output-dir .

          # The web UI is now in ./web/
          cd ..

      - name: Deploy to GitHub Pages
        run: |
          # Switch to gh-pages branch (create if needed)
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages

          # Remove all existing files
          git rm -rf . 2>/dev/null || true
          rm -rf * .gitignore .gitattributes 2>/dev/null || true

          # Copy generated web UI
          cp -r demo-build/web/* .

          # Add a README
          cat > README.md << 'EOF'
          # annextube Demo

          This demo is automatically generated from the @AnnexTubeTesting channel.

          It showcases:
          - Video metadata browsing
          - Playlist navigation
          - Search functionality
          - Client-side static web UI (no backend required)

          Generated from: https://github.com/con/annextube
          EOF

          # Commit and push
          git add -A
          git commit -m "Deploy demo generated from ${{ github.sha }}" || echo "No changes"
          git push origin gh-pages --force
