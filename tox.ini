[tox]
envlist = py3{10,11,12,13,14},lint,type,e2e
skip_missing_interpreters = true

[testenv]
skip_install = false
deps = .[test]
passenv =
    YOUTUBE_API_KEY
    ANNEXTUBE_COOKIES_FILE
    ANNEXTUBE_COOKIES_FROM_BROWSER
    LANG
    LC_ALL
    LC_CTYPE
    PYTHONIOENCODING
setenv =
    PYTHONIOENCODING = utf-8
commands = pytest {posargs:tests/}

[testenv:lint]
skip_install = true
deps = .[devel]
commands = ruff check annextube/ tests/

[testenv:format]
skip_install = true
deps = .[devel]
commands = ruff format annextube/ tests/

[testenv:type]
skip_install = true
deps = .[devel]
commands = mypy --ignore-missing-imports annextube/

[testenv:network]
skip_install = false
deps = .[test]
passenv =
    YOUTUBE_API_KEY
    ANNEXTUBE_COOKIES_FILE
    ANNEXTUBE_COOKIES_FROM_BROWSER
    LANG
    LC_ALL
    LC_CTYPE
    PYTHONIOENCODING
setenv =
    PYTHONIOENCODING = utf-8
commands = pytest -m network {posargs:tests/}

[testenv:cov]
skip_install = false
deps = .[test]
commands = pytest --cov=annextube --cov-report=html --cov-report=term {posargs:tests/}

[testenv:full]
description = Run all non-network tests with all optional deps (including playwright)
skip_install = false
deps = .[e2e]
allowlist_externals = bash
passenv =
    YOUTUBE_API_KEY
    ANNEXTUBE_COOKIES_FILE
    ANNEXTUBE_COOKIES_FROM_BROWSER
    LANG
    LC_ALL
    LC_CTYPE
    PYTHONIOENCODING
setenv =
    PYTHONIOENCODING = utf-8
commands =
    bash -c 'playwright install --with-deps chromium 2>/dev/null || echo "Note: playwright browser install failed, browser tests may be skipped"'
    pytest {posargs:tests/}

[testenv:sdist-check]
description = Verify sdist includes built frontend and generate-web works
skip_install = false
deps = .[test]
allowlist_externals = rm
commands =
    # Remove project-root web/ so tests can't accidentally pass by
    # finding the local copy instead of the installed one
    rm -rf {toxinidir}/web
    pytest {posargs:tests/unit/test_sdist_frontend.py} -v

[testenv:e2e-fixture]
skip_install = false
deps = .[test]
passenv = YOUTUBE_API_KEY
allowlist_externals = bash
commands =
    bash frontend/scripts/create-e2e-fixture.sh test-archives/archive-workflow-fixture

[testenv:e2e]
skip_install = false
deps = .[test]
allowlist_externals =
    npm
    bash
changedir = frontend
commands =
    npm install
    npm run build
    bash scripts/ensure-playwright-browsers.sh chromium
    bash -c 'if [ -f ../test-archives/archive-workflow-fixture/.annextube/config.toml ]; then npx playwright test archive-workflow.spec.ts --project=archive-chromium; else echo "SKIP: archive E2E tests (run: tox -e e2e-fixture)"; fi'

[gh-actions]
python =
    3.10: py310
    3.11: py311
    3.12: py312, lint, type, cov
    3.13: py313
    3.14: py314
